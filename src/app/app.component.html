<div class="wrapper">
  <!-- Header -->
  <div class="header">
    <div class="flex items-center justify-between" style="width: 100%;">
      <div class="flex items-center">
        <h1>WCA Competition Certificates</h1>
        <h6>{{version()}}</h6>
      </div>
      <div class="auth-section">
        @if (authService.isLoggedIn()) {
          <button class="btn-secondary" (click)="logout()">Log Out (WCA)</button>
        } @else {
          <button class="btn-secondary" (click)="login()">Log In (WCA)</button>
        }
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">

    <!-- COMPETITION SELECTION -->
    @if (!competitionId) {
      <div class="comp-selection">
        <h2>Select Competition</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Choose from Irish competitions or enter a custom competition ID</p>

        @if (authService.isLoggedIn()) {

        @if (competitionsToChooseFrom) {

          <!-- IN PROGRESS COMPETITIONS -->
          @if (inProgressCompetitions.length > 0) {
            <div class="comp-category">
              <div class="comp-category-header">
                <h3 style="color: var(--success-color); margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                  ● In Progress ({{ inProgressCompetitions.length }})
                </h3>
              </div>
              <div class="comp-grid">
                @for (comp of inProgressCompetitions; track comp.id) {
                  <button class="competition competition-active"
                          (click)="handleCompetitionSelected(comp.id)"
                          [title]="comp.name + ' • ' + formatCompetitionDate(comp)">
                    <div class="comp-name">{{ comp.name }}</div>
                    <div class="comp-date">{{ formatCompetitionDate(comp) }}</div>
                  </button>
                }
              </div>
            </div>
          }

          <!-- FUTURE COMPETITIONS -->
          @if (futureCompetitions.length > 0) {
            <div class="comp-category">
              <div class="comp-category-header">
                <h3 style="color: var(--accent-primary); margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                  ↗ Upcoming ({{ futureCompetitions.length }})
                </h3>
              </div>
              <div class="comp-grid">
                @for (comp of futureCompetitions; track comp.id) {
                  <button class="competition competition-future"
                          (click)="handleCompetitionSelected(comp.id)"
                          [title]="comp.name + ' • ' + formatCompetitionDate(comp)">
                    <div class="comp-name">{{ comp.name }}</div>
                    <div class="comp-date">{{ formatCompetitionDate(comp) }}</div>
                  </button>
                }
              </div>
            </div>
          }

          <!-- PAST COMPETITIONS -->
          @if (pastCompetitions.length > 0) {
            <div class="comp-category">
              <div class="comp-category-header">
                <h3 style="color: var(--text-muted); margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                  ✓ Completed ({{ pastCompetitions.length }})
                </h3>
              </div>
              <div class="comp-grid">
                @for (comp of pastCompetitions; track comp.id) {
                  <button class="competition competition-past"
                          (click)="handleCompetitionSelected(comp.id)"
                          [title]="comp.name + ' • ' + formatCompetitionDate(comp)">
                    <div class="comp-name">{{ comp.name }}</div>
                    <div class="comp-date">{{ formatCompetitionDate(comp) }}</div>
                  </button>
                }
              </div>
            </div>
          }

          <!-- Custom Competition Input -->
          <div class="custom-comp">
            <label for="custom-comp-id" style="color: var(--text-secondary); font-size: 12px; min-width: 120px;">Custom ID:</label>
            <input id="custom-comp-id"
                   type="text"
                   [(ngModel)]="customCompetitionId"
                   placeholder="Enter competition ID"
                   style="flex: 1;">
            <button class="btn-secondary" (click)="handleCompetitionSelected(customCompetitionId)">Load</button>
          </div>

          @if (competitionsToChooseFrom && competitionsToChooseFrom.length === 0) {
            <div style="text-align: center; color: var(--warning-color); padding: 20px; background: var(--bg-tertiary); border-radius: 4px; margin-top: 16px;">
              No Irish competitions found in the selected date range
            </div>
          }
          @if (!competitionsToChooseFrom) {
            <div style="text-align: center; color: var(--text-secondary); padding: 20px; background: var(--bg-tertiary); border-radius: 4px; margin-top: 16px;">
              Loading competitions...
            </div>
          }
        }

        } @else {
          <div style="text-align: center; padding: 40px 20px; background: var(--bg-tertiary); border-radius: 8px; margin-top: 16px;">
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Please log in with your WCA account to access competitions.</p>
            <button class="btn-primary" (click)="login()">Log In (WCA)</button>
          </div>
        }
      </div>
    }

    <!-- MAIN INTERFACE -->
    @if (competitionId && wcif) {
      <div class="comp-interface">

        <!-- Competition Header -->
        <div class="comp-header">
          <div style="flex: 1; min-width: 0;">
            <h2 class="comp-title">{{ competitionId }}</h2>
            <div style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">
              {{ events?.length }} events • {{ acceptedPersons }} competitors
            </div>
          </div>
          <div class="comp-actions">
            <button class="btn-secondary" (click)="handleRefreshCompetition()">Refresh Data</button>
          </div>
        </div>

        <!-- Saved Templates -->
        <div class="template-actions">
          <h3>Saved Templates</h3>
          <p class="template-hint">Background images are not included in saved templates.</p>

          <div class="flex gap-4 flex-wrap items-center">
            <button class="btn-secondary" (click)="loadTemplateFromServer()" [disabled]="reloadingTemplate" data-cy="load-template">
              @if (reloadingTemplate) {
                Loading...
              } @else {
                Load Saved Template
              }
            </button>

            <button class="btn-primary" (click)="saveTemplate()" [disabled]="!authService.isLoggedIn() || savingTemplate" data-cy="save-template"
                    [title]="authService.isLoggedIn() ? '' : 'Log in with WCA to save templates'">
              @if (savingTemplate) {
                Saving...
              } @else {
                Save Template on WCA
              }
            </button>
          </div>

          @if (templateMessage) {
            <div class="template-message-{{ templateMessage.type }}" data-cy="template-message">{{ templateMessage.text }}</div>
          }
        </div>

        <!-- Tabs -->
        <mat-tab-group>

          <!-- PODIUM CERTIFICATES TAB -->
          <mat-tab label="Podium Certificates">
            <div class="events-section">
              @if (state === 'REFRESHING') {
                <div class="status-refreshing">
                  Refreshing competition data...
                </div>
              }

              @if (state !== 'REFRESHING') {
                <!-- Events Table -->
                <table class="events-table">
                  <thead>
                    <tr>
                      <th style="width: 60px;">Print</th>
                      <th style="width: 45%;">Event</th>
                      <th style="width: auto;">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (event of wcif.events; track event.id) {
                      <tr class="event-row"
                          (click)="toggleEventSelection(event, $event)"
                          [class.selected]="event.printCertificate">
                        <td>
                          <input type="checkbox"
                                 class="event-checkbox"
                                 [(ngModel)]="event.printCertificate"
                                 (click)="$event.stopPropagation()">
                        </td>
                        <td style="font-weight: 500;">{{ printService.getEventName(event.id) }}</td>
                        <td class="event-warning">{{ getWarningIfAny(event.id) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>

                <!-- Download Actions -->
                <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; align-items: center;">
                  <button class="btn-primary"
                          (click)="printCertificatesAsPdf()"
                          [disabled]="printDisabled()">
                    Download PDF
                  </button>
                  <button class="btn-secondary"
                          (click)="printCertificatesAsPreview()"
                          [disabled]="printDisabled()">
                    Preview
                  </button>
                  @if (printService.background && printService.backgroundForPreviewOnly) {
                    <label for="backgroundForPreview">Background applied to preview only</label>
                  }
                </div>
              }
            </div>
          </mat-tab>

          <!-- CUSTOMIZE PODIUM TAB -->
          <mat-tab label="Customize Podium">
            <div class="p-4">


              <!-- Template Configuration -->
              <div class="mb-4">
                <label for="podium-template" class="field-label">Certificate Template:</label>
                <textarea id="podium-template" [(ngModel)]="printService.podiumCertificateJson"
                          placeholder="Certificate template JSON..."></textarea>
                <button class="btn-secondary" style="margin-left: 8px;" (click)="printService.resetPodiumCertificateJson()">Reset to Default Template</button>
              </div>

              <div class="mb-4">
                <label for="podium-style" class="field-label">Style Configuration:</label>
                <textarea id="podium-style" [(ngModel)]="printService.podiumCertificateStyleJson"
                          placeholder="Style configuration JSON..."></textarea>
                <button class="btn-secondary" style="margin-left: 8px;" (click)="printService.resetPodiumCertificateStyleJson()">Reset to Default Style</button>
              </div>

              <!-- Additional Options -->
              <div class="flex flex-col gap-4">
                <div class="flex items-center gap-4">
                  <label for="podium-background" class="field-label-inline">Background:</label>
                  <input id="podium-background" #backgroundFileInput type="file" (change)="printService.handleBackgroundSelected($event.target.files)"/>
                  @if (printService.background) {
                    <label for="backgroundForPreview">For preview only</label>
                    <input id="backgroundForPreview" 
                                 type="checkbox"
                                 class="event-checkbox"
                                 [(ngModel)]="printService.backgroundForPreviewOnly"
                                 (click)="$event.stopPropagation()">
                    <span style="color: var(--success-color); font-size: 12px;">✓ Background set</span>
                    <button class="btn-secondary"
                          (click)="clearBackground(backgroundFileInput)"
                          [disabled]="!printService.background">Clear</button>
                  }
                  @if (!printService.background) {
                    <span style="color: var(--text-muted); font-size: 12px;">No background</span>
                  }
                </div>

                <div class="flex items-center gap-4">
                  <label for="podium-orientation" class="field-label-inline">Orientation:</label>
                  <select id="podium-orientation" [(ngModel)]='printService.pageOrientation' style="max-width: 150px;">
                    <option value='landscape'>Landscape</option>
                    <option value='portrait'>Portrait</option>
                  </select>
                </div>

                <div class="flex items-center gap-4">
                  <label for="podium-countries" class="field-label-inline">Countries filter:</label>
                  <input id="podium-countries" [(ngModel)]='printService.countries'
                         type="text"
                         placeholder="ISO codes (semicolon-separated)"
                         style="flex: 1; max-width: 300px;"/>
                </div>

                <div class="flex items-center gap-4">
                  <label for="podium-xoffset" class="field-label-inline">X Offset:</label>
                  <input id="podium-xoffset" [(ngModel)]='printService.xOffset'
                         type="number"
                         placeholder="0"
                         style="max-width: 100px;"/>
                  <span style="color: var(--text-muted); font-size: 12px;">Points (positive = right, negative = left)</span>
                </div>
              </div>

            </div>
          </mat-tab>

        </mat-tab-group>
      </div>
    }

    <!-- Error Display -->
    @if (error) {
      <div class="error-message">
        <strong>Error:</strong> {{error.toString()}}
      </div>
    }

    <!-- Loading Display -->
    @if (loading) {
      <div class="loading-message">
        Loading competition data...
      </div>
    }
  </div>

  <!-- Footer -->
  <div class="footer">
    <a href="https://github.com/speedcubing-ireland/wca-certificates" target="_blank">Source Code</a>
  </div>
</div>
